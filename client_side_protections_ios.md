# Client-Side Protections Bypass - iOS
<img height=400 src="https://user-images.githubusercontent.com/54555784/224457765-8464c534-fd6a-449d-b9e8-32b820a8c433.png" />

Getting protection details:  
-> Debugging with idevicesyslog  
-> Analysis of classes and methods at runtime - frida/objection  
-> Reverse Engineering and Code Analysis  

### Debugging with idevicesyslog, stack trace analysis
To obtain your device ID
```
idevice_id --list
```

-> Capture logs from your app
```
idevicesyslog -u <device_id> | grep <bundle_identifier>
```

## Analysis of classes and methods
-> listing classes - frida script
```
frida -U -f <bundle_identifier> -l find-all-classes.js
```
https://raw.githubusercontent.com/interference-security/frida-scripts/master/iOS/find-all-classes.js

-> listing classes - objection
```
objection --gadget <bundle_identifier> explore -s "ios hooking list classes"
```

-> list methods of a class - objection
```
objection --gadget <bundle_identifier> explore -s "ios hooking list class_methods <class_name>"
```

-> Search for the code responsible for Anti-Jailbreak protection using Hopper, IDA Pro, Ghidra, Radare2  

## Anti-Jailbreak Bypass
### Anti-Jailbreak Bypass with Objection
```
objection --gadget <bundle_identifier> explore -s "ios jailbreak disable"
```

### Anti-Jailbreak Bypass with Frida Scripts
```
frida -U -f <bundle_identifier> -l <script>.js
```
https://codeshare.frida.re/@incogbyte/ios-jailbreak-bypass/  
https://codeshare.frida.re/@liangxiaoyi1024/ios-jailbreak-detection-bypass/

### Reverse Engineering with Hopper (Disassembler)  
https://developer.arm.com/documentation/dui0802/a/A64-General-Instructions/TBZ
https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/TBNZ
https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/

## Anti-Emulator Bypass
Techniques for detecting emulation can vary in approaches that include: 

-> Checking device properties: Just like Android, apps can attempt to check certain device properties to determine if they are running on an emulator. This may include checking properties such as device model, iOS version, presence of specific system files, among others. 

-> Digital signature detection: Developers can implement checks to detect whether the application was signed with a valid development certificate, as emulators may use different certificates than real devices.

-> Behavior analysis: Some applications may monitor user behavior to detect patterns that indicate they are running in an inauthentic environment. For example, if the app detects activity that is unusual or inconsistent with the typical behavior of a real iOS device, it can take steps to mitigate potential security risks.

-> Detection of emulator-specific APIs or features: Developers can check for the presence of emulator-specific APIs or features that are not typically present on real iOS devices.

[X] In construction

## SSL Pinning Bypass
-> Frida  
-> Objection  
-> SSL Kill Switch 2/SSL Kill Switch 3  
-> Bypass via Replacing Hard-Coded Certificate/Sha 256 Hash  
-> Reverse Engineering with with Hopper  

### Configure Proxy
1. Install certificate burp  
2. Activating trust in the installed certificate -> Settings > General > About > Certificate Trust Settings  
3. Install Mobile assistant -> Add http://<burp_ip>:<burp_port> in Cydia/APT URL  

-> More details: [Intercepting Traffic in iOS Apps](intercepting_traffic_in_ios_apps.md)

###  SSL Pinning Bypass with Frida
```
frida -U -f <bundle_identifier> -l <script>.js --no-pause
```

https://codeshare.frida.re/@snooze6/ios-pinning-disable/  
https://codeshare.frida.re/@federicodotta/ios13-pinning-bypass/  
https://github.com/httptoolkit/frida-interception-and-unpinning  
https://codeshare.frida.re/@zionspike/bypass-flutter-pinning-ios/

### SSL Pinning Bypass with Objection
1- Add https://build.frida.re in Cydia/APT URL Cydia -> install frida  
```
objection --gadget <bundle_identifier> explore -s "ios sslpinning disable"
```

### Bypass via Replacing Hard-Coded Certificate
```
unzip .ipa
find . | grep .cer
cp ~/Path_of_Your_burp_certificate  ./Full_Path_Of_Hardcoded_Certificate
```  
1. Zip the Payload folder
2. Rename the zip to .IPA  
3. Install the app via Cydia impactor  

### SSL Kill Switch 2 

SSL Kill Switch 2 is an effective tool for intercepting and analysing SSL/TLS traffic between applications and servers, allowing a more in-depth view of encrypted communications in security tests. **The tool is compatible up to iOS 14.2**.

1 - Install "[SSLKillSwitch](https://github.com/nabla-c0d3/ssl-kill-switch2)" on Cydia 2 - Settings -> SSL Kill Switch Application -> Disable Certificate Validation

### SSL Kill Switch 3

SSL Kill Switch 3 is a significant update to its predecessor, with new features such as support for iOS 15+ and ARM64/ARM64e devices, operation without the need for root, and advanced techniques for bypassing SSL certificate pinning. These innovations extend the tool's applicability to newer models of iOS devices.

To install it, just follow the tutorial available on the project: https://github.com/NyaMisty/ssl-kill-switch3#usage 

-> Sileo https://repo.misty.moe/apt

### Bypass via Replacing Hard-Coded Sha256
Generate your burp suite certificate hash via the following command 
```
unzip .IPA
openssl x509 -inform DER -in cacert.cer -out cacert.crt
openssl x509 -in cacert.crt -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | openssl enc -base64
```
Replace our hash value with application hash via any editor.  
1. Zip the Payload folder  
2. Rename the zip to .IPA  
3. Install the app via Cydia impactor  

## Anti-Frida Bypass
The anti-frida performs the blockade by detecting:  
- Changes of Instructions;  
- Port used by frida;  
- Named pipes and threads used by Frida;  
- Comparison of the text section in memory with the text section in disk for libc and native library.  
Keep in mind that you need to analyze the code to find out how to better bypass the anti-frida used by the app.
 
-> script anti-frida-bypass  
https://codeshare.frida.re/@enovella/anti-frida-bypass/

-> bypass for change port
```
/var/jb/usr/sbin/frida-server -l 0.0.0.0:19991
```

-> communicating with Frida on a different port
```
frida -H 192.168.0.22:19991 -f <name_identifier> -l ios-utils.js
```

## End-to-end Encryption Bypass
![image](https://user-images.githubusercontent.com/54555784/224218113-3713d900-7619-4388-8ed3-b85b092909a6.png)

Understand how the application is encrypting the data and decrypting it to obtain their encryption keys and tamper with the decrypted data.  
If end-to-end encryption is used, even if we have done the certificate installation, bypass SSL pinning and managed to intercept the traffic using a proxy(burp), we will not be able to see the plaintext traffic. This is custom encryption that is built in by the developer. that the application contains on top of SSL.
That means we will also have SSL along with that.  
-> Static analysis  
-> Perform at runtime tracing  
Case:  
-> AES 256 being used for encrypt/decrypt data  
-> Client and server with the same encryption key  

### Getting crypto Key - end-to-end
-> Tracing crypto calls and dealing with end-to-end encryption  
```
frida-trace -U -m "*[NSURLRequest *]" -n <app_name>
```  
-> Duming crypto keys - Objection  
e.g.  
```
ios hooking watch method "-[NSData <method>:error:]" --dump-args --dump-return --dump-backtrace
```
